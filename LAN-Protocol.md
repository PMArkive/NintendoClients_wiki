This page describes the protocol that's used to find nearby consoles in LAN mode. In this mode, UDP broadcast packets are used to discover other consoles. LAN mode is not the default mode for local multiplayer. It can usually be enabled by pressing L + R + Left Stick in one of the menus.

The crypto challenge in the [browse request](#0-browse-request) and [reply](#1-browse-reply) uses a [game-specific key](#game-specific-keys).

Every packet starts with a single byte that indicates its type.

## Packet types
| Value | Description |
| --- | --- |
| 0 | [Browse request](#0-browse-request) |
| 1 | [Browse reply](#1-browse-reply) |
| 3 | Get host request |
| 4 | Get host reply |
| 5 | Get session request |
| 6 | Get session reply |
| 7 | Keep alive message |

## (0) Browse Request
This packet is sent through UDP broadcast port 30000.

| Offset | Size | Description |
| --- | --- | --- |
| 0x0 | 1 | Packet type (0) |
| 0x1 | 4 | Size of search criteria (0x23A) |
| 0x5 | 0x23A | [LanSessionSearchCriteria](#lansessionsearchcriteria) |
| 0x23F | 0x12A | [Crypto challenge](#crypto-challenge) |

### LanSessionSearchCriteria
| Offset | Size | Description |
| --- | --- | --- |
| 0x0 | 4 | Minimum number of participants ([range](#range)) |
| 0x4 | 4 | Maximum number of participants ([range](#range)) |
| 0x8 | 1 | Opened only |
| 0x9 | 1 | Vacant only |
| 0xA | 4 | Result range offset |
| 0xE | 4 | Result range size |
| 0x12 | 4 | Game mode |
| 0x16 | 4 | Session type |
| 0x1A | 0x50 * 6 | [Attribute lists](#attribute-list) |
| 0x1FA | 1 * 6 | Number of attributes |
| 0x200 | 4 * 6 | Attribute range min |
| 0x218 | 4 * 6 | Attribute range max |
| 0x230 | 1 * 6 | Is attribute range used |
| 0x236 | 4 | [Validity flags](#validity-flags) |

#### Validity flags
These flags indicate which fields have a valid value set.

| Mask | Description |
| --- | --- |
| 0x1 | Minimum number of participants |
| 0x2 | Maximum number of participants |
| 0x4 | Opened only |
| 0x8 | Vacant only |
| 0x10 | Game mode |
| 0x20 | Session type |
| 0x40 | First attribute list |
| ... | ... |
| 0x800 | Last attribute list |

#### Range
| Offset | Size | Description |
| --- | --- | --- |
| 0x0 | 2 | Minimum |
| 0x2 | 2 | Maximum |

#### Attribute list
Each attribute list may contain up to 20 attributes. Every attribute is stored as a 4-byte integer.

## (1) Browse reply
| Type | Description |
| --- | --- |
| Uint8 | Packet type (1) |
| Uint32 | Size of session info |
| [LanSessionInfo](#lansessioninfo) | Session info |
| Bytes | [Crypto challenge reply](#crypto-challenge) |

### LanSessionInfo
| Type | Description |
| --- | --- |
| Uint32 | Game mode |
| Uint32 | Session id |
| Uint32 (x6) | Attributes |
| Uint16 | Current number of participants |
| Uint16 | Minimum number of participants |
| Uint16 | Maximum number of participants |
| Uint8 | System communication version |
| Uint8 | Application communication version |
| Uint16 | Session type |
| Bytes (0x180) | Application data |
| Uint32 | Application data size |
| Bool | Is opened |
| [StationLocation](PIA-Types#stationlocation) | Host address |
| [LanStationInfo](#lanstationinfo) (x16) | Station info of every player in the room |
| Bytes (0x20) | Session param |

#### LanStationInfo
| Offset | Size | Description |
| --- | --- | --- |
| 0x0 | 1 | Role |
| 0x1 | 1 | Username encoding type (1=utf8, 2=utf16) |
| 0x2 | 40 | Username |
| 0x2A | 8 | Station id |

## Crypto Challenge
The [browse request](#0-browse-request) contains a cryptographic challenge that must be correctly answered in the [browse reply](#1-browse-reply). Both the challenge and the response have the following format:

| Offset | Size | Description |
| --- | --- | --- |
| 0x0 | 1 | Version. If 1, the old [InetAddress](PIA-Types#inetaddress) format is used. If 2, the new format is used. |
| 0x1 | 1 | Crypto enabled (0 or 1) |
| 0x2 | 8 | Incrementing counter used for nonce |
| 0xA | 16 | Challenge key |
| 0x1A | 16 | Authentication tag for AES-GCM |
| 0x2A | 256 or 16 | Challenge or response, encrypted with AES-GCM |

The content of the challenge/response when crypto is enabled is described below. If crypto is disabled the authentication tag and challenge/response data are filled with random bytes.

The nonce for the AES-GCM algorithm is generated as follows:

| Offset | Size | Description |
| --- | --- | --- |
| 0x0 | 4 | Broadcast address (<code>local_address &vert; ~subnet_mask</code>) |
| 0x4 | 8 | Nonce counter |

### Challenge
The challenge consists of 256 random bytes. The key for encrypting the challenge is generated by AES-encrypting the challenge key with a game-specific key.

### Response
The response contains the first 16 bytes of the HMAC-SHA256 of the decrypted challenge with a game-specific key. The key for encrypting the response is the first 16 bytes of the HMAC-SHA256 of the following data with the same game-specific key:

| Offset | Size | Description |
| --- | --- | --- |
| 0x0 | 16 | Challenge key in browse response |
| 0x10 | 16 | Challenge key received in browse request |

## Game-Specific Keys
Most first-party games use [ENL](ENL-Key-Generation) to derive the key.

| Game | Key |
| --- | --- |
| Pokemon Sword/Shield | `p1frXqxmeCZWFv0X` |
| Splatoon 2 | `ee182a63e216cdb1f51ad4bed8cf6508` |
| Super Mario Maker 2 | `667c18475889faab61f93ef1da180971` |