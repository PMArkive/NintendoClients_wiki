# Overview
When requesting a NEX token from the account server, one of the things the server returns is your NEX password. This password is never sent to the authentication server. Instead, it is used to derive the Kerberos key. The Kerberos key is used to decrypt the Kerberos ticket received from the authentication server, which (among other information) contains the key that will be used in communication with the secure server.

## Kerberos Encryption
First, the data is encrypted with RC4. Then a HMAC of the encrypted data is appended to the data. The decryption process is the reverse: first check the HMAC, then decrypt.

## Key Derivation
The Kerberos ticket is encrypted with the following key:

**3DS / Wii U**: The Kerberos key is generated by MD5-hashing the password `65000 + pid % 1024` times.

**Switch**: The Kerberos key is calculated as follows: ```key = MD5(MD5(password) + PACK("<Q", pid))```

## Kerberos Ticket
| Type | Description |
| --- | --- |
| Bytes | Secure key |
| [PID] | Unknown |
| [Buffer] | [Ticket data](#ticket-data) |

The length of the secure key is always 32 bytes, except in communication with the friends server, in which case it's 16 bytes.

## Ticket Data
### 3DS / Wii U
Unknown

### Switch
| Type | Description |
| --- | --- |
| [Buffer] | Ticket key |
| [Buffer] | Kerberos-encrypted ticket info |

#### Ticket info
The key used to encrypt the ticket info is somehow based on the Kerberos key and the ticket key, but the details are unknown.

| Type | Description |
| --- | --- |
| [DateTime] | Date time |
| [PID] | User pid |
| Bytes | Unknown key (32 bytes) |

[Buffer]: NEX-Common-Types#buffer
[PID]: NEX-Common-Types#pid
[DateTime]: NEX-Common-Types#datetime